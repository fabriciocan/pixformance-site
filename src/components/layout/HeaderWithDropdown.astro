---
/**
 * Header Component with Dropdown - Pixformance
 * Navigation header with Lösungen dropdown menu
 */
import type { HTMLAttributes } from 'astro/types';
import { cn } from '@/lib/cn';
import { headerVariants, headerInnerVariants } from './header.variants';
import Button from '@/components/ui/form/Button/Button.astro';
import Icon from '@/components/ui/primitives/Icon/Icon.astro';

interface Props extends HTMLAttributes<'header'> {
  position?: 'fixed' | 'sticky' | 'static';
  size?: 'sm' | 'md' | 'lg';
  variant?: 'default' | 'solid' | 'transparent';
  class?: string;
}

const {
  position = 'sticky',
  size = 'md',
  variant = 'default',
  class: className,
  ...attrs
} = Astro.props;

const currentPath = Astro.url.pathname;
const hasLogoSlot = Astro.slots.has('logo');

const headerClasses = cn(headerVariants({ position, variant }), className);
const innerClasses = headerInnerVariants({ size });

const losungenItems = [
  { label: 'Physiotherapie', href: '/physiotherapie' },
  { label: 'Klinik', href: '/klinik' },
  { label: 'Fitness', href: '/fitness' },
  { label: 'Firmen Fitness', href: '/firmen-fitness' },
];

const unternehmensLinks = [
  { label: 'Über uns', href: '/ueber-uns' },
  { label: 'Blog', href: '/blog' },
  { label: 'FAQ', href: '/faq' },
];

function isActive(href: string): boolean {
  if (href.startsWith('#')) return false;
  if (href === '/') return currentPath === '/';
  return currentPath === href || currentPath.startsWith(href + '/');
}

const isLosungenActive = losungenItems.some((item) => isActive(item.href));
const isUnternehmensActive = unternehmensLinks.some((item) => isActive(item.href));

const menuId = `mobile-menu-${Math.random().toString(36).slice(2, 9)}`;
const buttonId = `${menuId}-button`;
---

<header class={headerClasses} {...attrs}>
  <div class={innerClasses}>
    {/* Logo */}
    {
      hasLogoSlot ? (
        <a href="/" class="flex items-center">
          <slot name="logo" />
        </a>
      ) : (
        <a href="/" class="flex items-center gap-2">
          <span class="font-display text-xl font-bold text-primary">
            Pixformance
          </span>
        </a>
      )
    }

    {/* Desktop Navigation */}
    <nav class="hidden items-center gap-1 md:flex" aria-label="Main navigation">
      {/* Lösungen Dropdown */}
      <div class="relative group">
        <button
          class={cn(
            'nav-link rounded-md px-3 py-2 text-sm font-medium flex items-center gap-1',
            'transition-colors',
            isLosungenActive
              ? 'text-primary font-semibold'
              : 'text-foreground-muted hover:text-foreground'
          )}
        >
          Lösungen
          <Icon name="chevron-down" size="sm" />
        </button>

        {/* Dropdown Menu */}
        <div
          class="absolute left-0 mt-1 w-48 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 bg-background border border-border rounded-lg shadow-lg z-50"
        >
          {
            losungenItems.map((item) => (
              <a
                href={item.href}
                class={cn(
                  'block px-4 py-2 text-sm hover:bg-secondary/10 first:rounded-t-lg last:rounded-b-lg',
                  isActive(item.href)
                    ? 'text-primary font-semibold'
                    : 'text-foreground-muted hover:text-foreground'
                )}
              >
                {item.label}
              </a>
            ))
          }
        </div>
      </div>

      {/* Unternehmen Dropdown */}
      <div class="relative group">
        <button
          class={cn(
            'nav-link rounded-md px-3 py-2 text-sm font-medium flex items-center gap-1',
            'transition-colors',
            isUnternehmensActive
              ? 'text-primary font-semibold'
              : 'text-foreground-muted hover:text-foreground'
          )}
        >
          Unternehmen
          <Icon name="chevron-down" size="sm" />
        </button>

        {/* Dropdown Menu */}
        <div
          class="absolute left-0 mt-1 w-48 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 bg-background border border-border rounded-lg shadow-lg z-50"
        >
          {
            unternehmensLinks.map((item) => (
              <a
                href={item.href}
                class={cn(
                  'block px-4 py-2 text-sm hover:bg-secondary/10 first:rounded-t-lg last:rounded-b-lg',
                  isActive(item.href)
                    ? 'text-primary font-semibold'
                    : 'text-foreground-muted hover:text-foreground'
                )}
              >
                {item.label}
              </a>
            ))
          }
        </div>
      </div>

      <a
        href="/konzept"
        class={cn(
          'nav-link rounded-md px-3 py-2 text-sm font-medium',
          'transition-colors',
          isActive('/konzept')
            ? 'text-primary font-semibold'
            : 'text-foreground-muted hover:text-foreground'
        )}
        aria-current={isActive('/konzept') ? 'page' : undefined}
      >
        Konzept
      </a>

      <a
        href="/testen"
        class={cn(
          'nav-link rounded-md px-3 py-2 text-sm font-medium',
          'transition-colors',
          isActive('/testen')
            ? 'text-primary font-semibold'
            : 'text-foreground-muted hover:text-foreground'
        )}
        aria-current={isActive('/testen') ? 'page' : undefined}
      >
        Testen
      </a>
    </nav>

    {/* Actions Area */}
    <div class="flex items-center gap-2">
      <Button size="sm" href="/testen" class="hidden md:inline-flex">
        Kontakt
      </Button>

      {/* Mobile Menu Toggle */}
      <button
        type="button"
        id={buttonId}
        class={cn(
          'inline-flex items-center justify-center rounded-md p-2 md:hidden',
          'text-foreground-muted hover:text-foreground',
          'transition-colors'
        )}
        aria-expanded="false"
        aria-controls={menuId}
        aria-label="Toggle menu"
      >
        <span class="menu-icon">
          <Icon name="menu" size="md" />
        </span>
        <span class="close-icon hidden">
          <Icon name="x" size="md" />
        </span>
      </button>
    </div>
  </div>

  {/* Mobile Menu */}
  <div
    id={menuId}
    class="border-border bg-background hidden border-t md:hidden"
    role="navigation"
    aria-label="Mobile navigation"
  >
    <div class="mx-auto max-w-6xl space-y-1 px-6 py-4">
      {/* Lösungen Mobile Submenu */}
      <div class="space-y-1">
        <p class="px-3 py-2 text-xs font-semibold text-foreground-muted uppercase">
          Lösungen
        </p>
        {
          losungenItems.map((item) => (
            <a
              href={item.href}
              class={cn(
                'mobile-nav-link block rounded-md px-6 py-2 text-sm font-medium',
                'transition-colors',
                isActive(item.href)
                  ? 'text-primary font-semibold'
                  : 'text-foreground-muted hover:text-foreground'
              )}
            >
              {item.label}
            </a>
          ))
        }
      </div>

      {/* Unternehmen Mobile Submenu */}
      <div class="space-y-1">
        <p class="px-3 py-2 text-xs font-semibold text-foreground-muted uppercase">
          Unternehmen
        </p>
        {
          unternehmensLinks.map((item) => (
            <a
              href={item.href}
              class={cn(
                'mobile-nav-link block rounded-md px-6 py-2 text-sm font-medium',
                'transition-colors',
                isActive(item.href)
                  ? 'text-primary font-semibold'
                  : 'text-foreground-muted hover:text-foreground'
              )}
            >
              {item.label}
            </a>
          ))
        }
      </div>

      <a
        href="/konzept"
        class={cn(
          'mobile-nav-link block rounded-md px-3 py-2 text-sm font-medium',
          'transition-colors',
          isActive('/konzept')
            ? 'text-primary font-semibold'
            : 'text-foreground-muted hover:text-foreground'
        )}
      >
        Konzept
      </a>

      <a
        href="/testen"
        class={cn(
          'mobile-nav-link block rounded-md px-3 py-2 text-sm font-medium',
          'transition-colors',
          isActive('/testen')
            ? 'text-primary font-semibold'
            : 'text-foreground-muted hover:text-foreground'
        )}
      >
        Testen
      </a>

      <div class="border-border mt-3 border-t pt-3">
        <Button fullWidth href="/testen">Kontakt</Button>
      </div>
    </div>
  </div>
</header>

<script define:vars={{ menuId, buttonId }}>
  function initMobileMenu() {
    const button = document.getElementById(buttonId);
    const menu = document.getElementById(menuId);
    const menuIcon = button?.querySelector('.menu-icon');
    const closeIcon = button?.querySelector('.close-icon');

    if (!button || !menu || !menuIcon || !closeIcon) return;

    let isOpen = false;

    function toggle() {
      isOpen = !isOpen;
      button.setAttribute('aria-expanded', isOpen.toString());

      if (isOpen) {
        menuIcon.classList.add('hidden');
        closeIcon.classList.remove('hidden');
        menu.classList.remove('hidden');
      } else {
        menuIcon.classList.remove('hidden');
        closeIcon.classList.add('hidden');
        menu.classList.add('hidden');
      }
    }

    button.addEventListener('click', toggle);

    menu.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', () => {
        if (isOpen) toggle();
      });
    });
  }

  initMobileMenu();
  document.addEventListener('astro:page-load', initMobileMenu);
</script>
