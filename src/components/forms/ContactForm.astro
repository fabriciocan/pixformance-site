---
import Button from '@/components/ui/form/Button/Button.astro';
import Icon from '@/components/ui/primitives/Icon/Icon.astro';

interface Props {
  variant?: 'default' | 'compact';
}

const { variant = 'default' } = Astro.props;
---

<form class="space-y-6" id="contact-form">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    {/* Nome */}
    <div>
      <label for="name" class="block text-sm font-medium mb-2">
        Name <span class="text-error">*</span>
      </label>
      <input
        type="text"
        id="name"
        name="name"
        required
        class="w-full px-4 py-3 rounded-lg border border-border bg-background focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
        placeholder="Ihr Name"
      />
    </div>

    {/* Email */}
    <div>
      <label for="email" class="block text-sm font-medium mb-2">
        E-Mail <span class="text-error">*</span>
      </label>
      <input
        type="email"
        id="email"
        name="email"
        required
        class="w-full px-4 py-3 rounded-lg border border-border bg-background focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
        placeholder="ihre.email@beispiel.de"
      />
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    {/* Empresa */}
    <div>
      <label for="company" class="block text-sm font-medium mb-2">
        Unternehmen / Einrichtung
      </label>
      <input
        type="text"
        id="company"
        name="company"
        class="w-full px-4 py-3 rounded-lg border border-border bg-background focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
        placeholder="Ihr Unternehmen"
      />
    </div>

    {/* Telefone */}
    <div>
      <label for="phone" class="block text-sm font-medium mb-2">
        Telefon
      </label>
      <input
        type="tel"
        id="phone"
        name="phone"
        class="w-full px-4 py-3 rounded-lg border border-border bg-background focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
        placeholder="+49 (0) ..."
      />
    </div>
  </div>

  {/* Interesse */}
  <div>
    <label for="interest" class="block text-sm font-medium mb-2">
      Interessenbereich
    </label>
    <select
      id="interest"
      name="interest"
      class="w-full px-4 py-3 rounded-lg border border-border bg-background focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
    >
      <option value="">Bitte wählen...</option>
      <option value="physiotherapie">Physiotherapie</option>
      <option value="klinik">Klinik</option>
      <option value="fitness">Fitness</option>
      <option value="bgm">BGM (Betriebliches Gesundheitsmanagement)</option>
      <option value="other">Sonstiges</option>
    </select>
  </div>

  {/* Mensagem */}
  <div>
    <label for="message" class="block text-sm font-medium mb-2">
      Ihre Nachricht <span class="text-error">*</span>
    </label>
    <textarea
      id="message"
      name="message"
      required
      rows="6"
      class="w-full px-4 py-3 rounded-lg border border-border bg-background focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all resize-none"
      placeholder="Teilen Sie uns mit, wie wir Ihnen helfen können..."
    ></textarea>
  </div>

  {/* Checkbox de privacidade */}
  <div class="flex items-start gap-3">
    <input
      type="checkbox"
      id="privacy"
      name="privacy"
      required
      class="mt-1 rounded border-border focus:ring-2 focus:ring-primary"
    />
    <label for="privacy" class="text-sm text-foreground-muted">
      Ich habe die <a href="/datenschutz" class="text-primary hover:underline"
        >Datenschutzerklärung</a
      > gelesen und bin damit einverstanden. <span class="text-error">*</span>
    </label>
  </div>

  {/* Botão de envio */}
  <div class="flex justify-start">
    <Button size="lg" type="submit">
      Anfrage senden
      <Icon name="send" size="sm" />
    </Button>
  </div>

  {/* Mensagem de sucesso/erro */}
  <div id="form-message" class="hidden"></div>
</form>

<script is:inline>
  (function () {
    var WEBHOOK_URL = 'https://webhook.pixformance.com/webhook/site-forms';

    function getUrlParams() {
      var params = {};
      new URLSearchParams(window.location.search).forEach(function (value, key) {
        params[key] = value;
      });
      return params;
    }

    function getCookies() {
      var cookies = {};
      if (!document.cookie) return cookies;
      document.cookie.split(';').forEach(function (cookie) {
        var idx = cookie.indexOf('=');
        if (idx === -1) return;
        var key = cookie.slice(0, idx).trim();
        var value = cookie.slice(idx + 1).trim();
        try { cookies[key] = decodeURIComponent(value); } catch (e) { cookies[key] = value; }
      });
      return cookies;
    }

    function showMessage(el, type, text) {
      el.classList.remove('hidden');
      el.className = type === 'success'
        ? 'p-4 rounded-lg bg-green-50 text-green-700 border border-green-200'
        : 'p-4 rounded-lg bg-red-50 text-red-700 border border-red-200';
      el.textContent = text;
    }

    function initForm() {
      var form = document.getElementById('contact-form');
      var messageDiv = document.getElementById('form-message');
      if (!form || !messageDiv) return;

      form.addEventListener('submit', function (e) {
        e.preventDefault();

        var submitBtn = form.querySelector('[type="submit"]');
        if (submitBtn) { submitBtn.disabled = true; submitBtn.style.opacity = '0.7'; }

        var formData = new FormData(form);
        var payload = {
          name: formData.get('name') || '',
          email: formData.get('email') || '',
          company: formData.get('company') || '',
          phone: formData.get('phone') || '',
          interest: formData.get('interest') || '',
          message: formData.get('message') || '',
          privacy_accepted: formData.get('privacy') === 'on',
          page_url: window.location.href,
          page_path: window.location.pathname,
          referrer: document.referrer || '',
          submitted_at: new Date().toISOString(),
          url_params: getUrlParams(),
          cookies: getCookies(),
        };

        fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        })
          .then(function (response) {
            if (response.ok) {
              showMessage(messageDiv, 'success', 'Vielen Dank für Ihre Anfrage! Wir werden uns in Kürze bei Ihnen melden.');
              form.reset();
              setTimeout(function () { messageDiv.classList.add('hidden'); }, 5000);
            } else {
              showMessage(messageDiv, 'error', 'Es ist ein Fehler aufgetreten. Bitte versuchen Sie es erneut oder kontaktieren Sie uns direkt.');
            }
          })
          .catch(function () {
            showMessage(messageDiv, 'error', 'Es ist ein Fehler aufgetreten. Bitte versuchen Sie es erneut oder kontaktieren Sie uns direkt.');
          })
          .finally(function () {
            if (submitBtn) { submitBtn.disabled = false; submitBtn.style.opacity = ''; }
          });
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initForm);
    } else {
      initForm();
    }
  })();
</script>
